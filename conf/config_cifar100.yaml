# JiT Training Configuration for CIFAR-100
# 使用 CIFAR-100 数据集进行测试（100 个类别）

trainer:
  max_epochs: 600
  accelerator: gpu
  devices: 1
  strategy: auto
  precision: bf16-mixed
  gradient_clip_val: 1.0
  accumulate_grad_batches: 1
  log_every_n_steps: 50
  enable_checkpointing: false
  enable_progress_bar: true
  enable_model_summary: true
  
  # SwanLab 日志记录器
  logger:
    class_path: swanlab.integration.pytorch_lightning.SwanLabLogger
    init_args:
      project: JiT-CIFAR100
      experiment_name: jit-b16-256
      description: "JiT-B/16 on CIFAR-100 (256x256)"
      config:
        model: JiT-B/16
        dataset: CIFAR-100
        img_size: 256
  
  callbacks:
    - class_path: callbacks.jit_callbacks.EMACallback
      init_args:
        ema_decay1: 0.9999
        ema_decay2: 0.9996
    
    - class_path: callbacks.jit_callbacks.JiTModelCheckpoint
      init_args:
        dirpath: ./outputs/cifar100/checkpoints
        save_last_freq: 10
        save_milestone_freq: 50
    
    - class_path: callbacks.jit_callbacks.LearningRateSchedulerCallback
      init_args:
        learning_rate: 0.00016  # 与 model.learning_rate 保持一致
        lr_schedule: constant
        warmup_epochs: 5
        min_lr: 0.0
        epochs: 100
    
    - class_path: callbacks.jit_callbacks.MetricLoggerCallback
      init_args:
        log_freq: 50
    
    # 图像生成和可视化
    - class_path: callbacks.jit_callbacks.ImageGenerationCallback
      init_args:
        num_samples: 16
        num_classes: 100          # CIFAR-100 有 100 个类别
        img_size: 256
        use_ema: true
        ema_version: 1
        log_every_n_epochs: 5     # CIFAR-100 每 5 个 epoch 记录一次

  # logger:
  #   class_path: lightning.pytorch.loggers.TensorBoardLogger
  #   init_args:
  #     save_dir: ./logs
  #     name: jit_cifar100

model:
  class_path: models.modelmodule.JiTLightningModule
  init_args:
    model_name: JiT-B/16
    img_size: 256
    num_classes: 100            # CIFAR-100 有 100 个类别
    attn_dropout: 0.0
    proj_dropout: 0.1           # 100 个类别可能需要更多正则化
    learning_rate: 5.0e-5
    weight_decay: 0.01          # 添加一些权重衰减
    ema_decay1: 0.9999
    ema_decay2: 0.9996
    P_mean: -0.8
    P_std: 0.8
    noise_scale: 1.0
    t_eps: 0.05
    label_drop_prob: 0.1
    sampling_method: heun
    num_sampling_steps: 50
    cfg_scale: 2.0
    cfg_interval: [0.1, 1.0]

data:
  class_path: datas.cifar_datamodule.CIFARDataModule
  init_args:
    data_path: ./data/cifar
    dataset_name: cifar100      # 使用 CIFAR-100
    download: true
    img_size: 256
    batch_size: 64
    num_workers: 4
    pin_memory: true

seed_everything: 42

